---
title: "Protección de semillas"
format: pdf
editor_options: 
  chunk_output_type: console
---

```{r Setup, include=F}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE)
```


```{r}
# "https://github.com/juanchiem/apptest2/blob/master/app.R" %>% browseURL()
library(tidyverse)
library(lme4)
library(emmeans)
library(multcomp)
library(performance)
library(printr)
library(ggstance)

conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("select", "dplyr")
asin_tran <- make.tran("asin.sqrt", 100)

```

## Dataset

```{r Meta}
# meta_cura <- gsheet2tbl("https://docs.google.com/spreadsheets/d/165Mu7j6k2QVZN4NPJvy42-WCj8WyH4C-flKlEF-NB4Y/edit#gid=663634411") 
# meta_cura %>% rio::export("data/meta_cura.csv")
# meta_cura <- read.csv("data/meta_cura.csv")
```

```{r Tratamientos}
# trat_cura <- gsheet2tbl("https://docs.google.com/spreadsheets/d/165Mu7j6k2QVZN4NPJvy42-WCj8WyH4C-flKlEF-NB4Y/edit#gid=1796511474")
# trat_cura %>% rio::export("data/trat_cura.csv")
# trat_cura <- read.csv("data/trat_cura.csv")%>%
#     mutate(prod = stringr::str_to_upper(prod))
# trat_cura %>% str
```

```{r croquis}
# plots_cura <- gsheet2tbl("https://docs.google.com/spreadsheets/d/165Mu7j6k2QVZN4NPJvy42-WCj8WyH4C-flKlEF-NB4Y/edit#gid=1847280538") 
  
# write.table(plots_cura, "data/plots_cura.csv",
#             na = "", row.names = FALSE, col.names = FALSE, append = TRUE, sep = ",")
# plots_cura <- read.csv("data/plots_cura.csv")

# plots_cura %>% 
#   # filter(regional==input$regional) %>%
#   # filter(regional=="tandilia") %>%
#   mutate(y=factor(y)) %>% 
#   select(-regional) %>% 
#   remove_empty() 
```

```{r cober_dat}
cober_dat <- read.csv("data/cober_dat.csv") %>% 
  rename(cultivo=crop, prod=trat_id) %>% 
    mutate(cultivo = if_else(cultivo=="C", "Cebada", "Trigo")) 
```

```{r}
cober_dat %>% 
  count(cultivo, prod, sitio) %>% 
  pivot_wider(names_from =  "sitio", 
              values_from = "n")
```

# Cobertura

```{r, eval=FALSE}
# "https://docs.google.com/spreadsheets/d/165Mu7j6k2QVZN4NPJvy42-WCj8WyH4C-flKlEF-NB4Y/edit#gid=1038456513" %>% 
#   # browseURL()
#   gsheet::gsheet2tbl() -> cober_raw
```

```{r, eval=FALSE}
# cober_dat <- cober_raw %>%
#       # filter(regional=="tandilia") %>%
#       # filter(regional=="necochea") %>%
#       pivot_longer(cols=contains("x"), names_to = "x", values_to = "val",
#                    names_prefix = "x") %>%
#       drop_na(val) %>%
#       left_join(plots_cura %>%
#                   pivot_longer(cols=contains("x"),
#                                names_to = "x",
#                                values_to = "crop_trat",
#                                names_prefix = "x")) %>%
#       separate(crop_trat,
#                into = c("crop", "trat"),
#                sep = "(?<=[A-Za-z])(?=[0-9])",
#                remove = F) %>%
#       mutate(crop = fct_rev(factor(crop)),
#              coords = paste(x, y, sep=","),
#              x = as.numeric(x))  %>%
#       left_join(trat_cura %>% select(sitio, crop_trat, trat_id)) %>%
# rio::export("data/cober_dat.csv")
```


```{r cober_plot, fig.width=8, fig.height=6}
cober_dat %>% 
  filter(!prod=="SISTIVA_PREMIS_2X") %>% 
  mutate(sitio = stringr::str_to_upper(sitio)) %>% 
  ggplot()+
  aes(x=prod, y= val)+
  facet_grid(cultivo ~ sitio, scales = "free") + 
  geom_point(alpha=.2) +
  # geom_text(aes(label=trt), size=3)+
  stat_summary(fun=mean, col="red") + 
  stat_summary(fun=mean, aes(label=round(after_stat(y))), geom="text", size=3, vjust=-.5) + 
  labs(y="Cobertura en macollaje  (%)", x="") + 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  coord_flip()
```

```{r, eval=FALSE}
last_plot() %>% 
  ggsave(filename = "plots/cobertura.jpg", w=8, h=6, units="cm", scale=3)
```

```{r eval=FALSE}
ftable(xtabs(~ cultivo + prod + sitio, cober_dat))
```

## Cebada 

```{r}
cober_dat %>% 
  filter(cultivo=="Cebada") %>% 
  ggplot()+
  aes(x = val) +
  geom_histogram() +
  geom_boxploth(aes(y = 3), width = 2, color = "blue", lwd = 2, alpha = .5) +
facet_grid(sitio ~ .)
```

### Análisis conjunto de 6 tratamientos 

```{r cober_C6}
cober_dat %>% 
  distinct(sitio, cultivo, prod) %>% 
  filter(cultivo=="Cebada") %>%
  filter(sitio=="La Dulce") %>% 
  select(-sitio) %>% 
  left_join(cober_dat) -> cober_C6

ftable(xtabs(~ cultivo + prod + sitio, cober_C6))
```

```{r}
mod_C6  <- with(asin_tran, 
                lmer(linkfun(val) ~ prod + (1|sitio), 
                     data = cober_C6))
# plot(mod_C6)
car::Anova(mod_C6)
emmeans(mod_C6, ~ prod, type = "response") %>% 
  cld(., Letters = letters, alpha = .1, reversed = T)
```

### Análisis conjunto de MDP + Tandil 

```{r cober_C2}
cober_dat %>% 
  filter(cultivo=="Cebada") %>%
  filter(sitio!="La Dulce") %>% 
  select(-sitio) %>% 
  left_join(cober_dat) -> cober_C2

ftable(xtabs(~ prod + sitio, cober_C2))
```

```{r}
mod_C2  <- with(asin_tran, 
                lmer(linkfun(val) ~ prod + (1|sitio), 
                     data = cober_C2))
# plot(mod_C2)
car::Anova(mod_C2)
mod_C2 %>% 
  emmeans(~ prod, type = "response") %>% 
  cld(., Letters = letters, alpha = .1, reversed = T)
```

## Trigo 

```{r}
cober_dat %>% 
  filter(cultivo=="Trigo") %>% 
  ggplot()+
  aes(x = val) +
  geom_histogram() +
  geom_boxploth(aes(y = 3), width = 2, color = "blue", lwd = 2, alpha = .5) +
facet_grid(sitio ~ .)
```

### Análisis conjunto de 6 tratamientos 

```{r}
cober_dat %>% 
  distinct(sitio, cultivo, prod) %>% 
  filter(sitio=="La Dulce") %>% 
  filter(cultivo=="Trigo") %>%
  select(-sitio) %>% 
  left_join(cober_dat) -> cober_T6

ftable(xtabs(~ cultivo + prod + sitio, cober_T6))
```

```{r}
lmer_T6  <- with(asin_tran, 
                lmer(linkfun(val) ~ prod + (1|sitio), 
                     data = cober_T6))
car::Anova(lmer_T6)
# plot(lmer_T6)
lmer_T6 %>% 
  emmeans(~ prod, type = "response") %>% 
  cld(., Letters = letters, alpha = .1, reversed = T)
```

### Análisis conjunto de MDP + Tandil 

```{r}
cober_dat %>% 
  filter(sitio!="La Dulce") %>% 
  filter(cultivo=="Trigo") %>%
  filter(!prod=="SISTIVA_PREMIS_2X") -> cober_T2 

ftable(xtabs(~ cultivo + prod + sitio, cober_T2))
```

```{r}
lmer_T2  <- with(asin_tran, 
                 lmer(linkfun(val) ~ prod + (1|sitio), 
                      data = cober_T2))
# plot(lmer_T2)
car::Anova(lmer_T2)
lmer_T2 %>% 
  emmeans(~ prod, type = "response") %>% 
  cld(., Letters = letters, alpha = .1, reversed = T)
```


# Rinde

```{r}
# rinde_cura <- raw_rinde %>% 
#   filter(protec=="semilla") %>% 
#   left_join(trat_cura)
# rinde_cura %>% rio::export("data/rinde_cura.csv")
rinde_cura <- rio::import("data/rinde_cura.csv") %>%
  select(sitio, cultivo, trt, prod, bq, kg_ha) %>%  filter(!(sitio=="La Dulce" & cultivo =="trigo" & trt ==3 & kg_ha > 2700)) %>% 
  add_case(sitio="MDP", cultivo="trigo", trt=10, prod="CHECK", bq=1, kg_ha=3819) %>% 
  group_by(cultivo, sitio, prod, bq) %>% 
  summarise(kg_ha=mean(kg_ha)) %>% 
  filter(!prod=="SISTIVA_PREMIS_2X") %>%
  ungroup()

# rinde_cura %>% 
#   # select(sitio, cultivo, prod, bq, kg_ha) %>% 
#   filter(cultivo=="trigo") %>% 
#   filter(sitio!="Tandil") %>% 
#   filter(prod %in% c("CHECK"))
# ftable(xtabs(~ cultivo + prod + sitio, rinde_cura %>% droplevels()))
```


```{r, eval=FALSE}
rinde_cura %>% 
  count(cultivo, prod, sitio) %>% 
  pivot_wider(names_from =  "sitio", 
              values_from = "n")
```

```{r fig.width=8, fig.height=6}
rinde_cura %>%   
  mutate(cultivo = stringr::str_to_sentence(cultivo)) %>%
  ggplot() + 
  aes(y=prod, x=kg_ha) + 
  facet_grid(cultivo ~ sitio, scales = "free") + 
  geom_point(alpha=.2) +
  # geom_text(aes(label=trt), size=3)+
  stat_summary(fun=mean, col="red") + 
  stat_summary(aes(label=round(..x..)), fun=mean, geom="text", size=3, vjust=-.5) + 
  scale_x_continuous(breaks = scales::pretty_breaks(5)) +
  labs(y="", x ="Rendimiento (kg/ha)", title = "") + 
  theme_bw()
```

```{r, eval=FALSE}
last_plot() %>% 
  ggsave(filename = "plots/rinde.jpg", w=8, h=6, units="cm", scale=3)
```

## Cebada

```{r}
rinde_cura %>% 
  filter(cultivo == "cebada") %>% 
  ggplot()+
  aes(x = kg_ha) +
  geom_histogram() +
  geom_boxploth(aes(y = 3), width = 2, color = "blue", lwd = 2, alpha = .5) +
  facet_grid(sitio ~ .)
```

### Análisis individual intra-sitio

```{r}
rinde_cura %>%
  filter(cultivo=="cebada") %>% 
  group_by(sitio) %>%
  group_modify(~ aov(kg_ha ~ prod + bq, data = .x) %>% 
                 agricolae::cv.model() %>% 
                 broom::tidy() 
  ) %>% 
  rename("cv%"=x) %>% 
  ungroup

rinde_cura %>%
  filter(cultivo=="cebada") %>% 
  group_by(sitio) %>%
  group_modify(~ 
                 lmer(kg_ha ~ prod + (1|bq), data = .x) %>%
                 emmeans(., ~ prod, type = "response") %>%
                 cld(., Letters = letters, alpha = .1,
                     type = "response", reversed = T) %>%
                 broom::tidy() %>% 
                 rename(kg_ha = estimate) %>%
                 mutate_if(is.character, as.factor)
               ) %>% 
  select(-std.error, -df) %>% 
  print(n=Inf)
```

### Análisis conjunto de 6 tratamientos 

```{r rinde_C6}
rinde_cura %>% 
  distinct(sitio, cultivo, prod) %>% 
  filter(sitio=="La Dulce") %>% 
  filter(cultivo=="cebada") %>%
  select(-sitio) %>% 
  left_join(rinde_cura) -> rinde_C6
ftable(xtabs(~ cultivo + prod + sitio, rinde_C6))
```

```{r}
mod_rinde_C6 <- lmer(sqrt(kg_ha) ~ prod + (1|sitio/bq), data=rinde_C6)
# plot(mod_rinde_C6)
# check_heteroscedasticity(mod_rinde_C6)
# check_normality(mod_rinde_C6)

mod_rinde_C6 %>% 
  emmeans(., ~ prod, type = "response") %>%  
  cld(., Letters = letters, alpha = .1,
      type = "response", reversed = T) %>%
  broom::tidy() %>% 
  rename(kg_ha = response, "tukey_10%"=.group) %>% select(-std.error, -df)
```

### Análisis conjunto de MDP + Tandil 

```{r}
rinde_cura %>% 
  filter(sitio!="La Dulce") %>% 
  filter(cultivo=="cebada") %>%
  filter(!prod=="SISTIVA_PREMIS_2X") -> rinde_C2 
ftable(xtabs(~ cultivo + prod + sitio, rinde_C2))
```

```{r}
mod_rinde_C2 <- lmer(kg_ha ~ prod + (1|sitio/bq), data=rinde_C2)
# plot(mod_rinde_C2)
# check_heteroscedasticity(mod_rinde_C2) 
# check_normality(mod_rinde_C2)

mod_rinde_C2 %>% 
  emmeans(~ prod, type = "response") %>%  
  cld(., Letters = letters, alpha = .1,
      type = "response", reversed = T) %>%
  broom::tidy() %>% 
  rename(kg_ha = estimate, "tukey_10%"=.group) %>% select(-std.error, -df)
```

## Trigo

```{r}
rinde_cura %>% 
  filter(cultivo == "trigo") %>% 
  ggplot()+
  aes(x = kg_ha) +
  geom_histogram() +
  geom_boxploth(aes(y = 3), width = 2, color = "blue", lwd = 2, alpha = .5) +
  facet_grid(sitio ~ .)
```


### Análisis individual intra-sitio

```{r}
rinde_cura %>%
  filter(cultivo=="trigo") %>% 
  group_by(sitio) %>%
  group_modify(~ aov(kg_ha ~ prod + bq, data = .x) %>% 
                 agricolae::cv.model() %>% 
                 broom::tidy() 
  ) %>% 
  rename("cv%"=x) %>% 
  ungroup
```


```{r}
rinde_cura %>%
  filter(cultivo=="trigo") %>% 
  group_by(sitio) %>%
  group_modify(~ 
                 lmer(kg_ha ~ prod + (1|bq), data = .x) %>%
                 emmeans(., ~ prod, type = "response") %>%
                 cld(., Letters = letters, alpha = .1,
                     type = "response", reversed = T) %>%
                 broom::tidy() %>% 
                 rename(kg_ha = estimate) %>%
                 mutate_if(is.character, as.factor)
               ) %>% 
  select(-std.error, -df) %>% 
  print(n=Inf)
```

### Análisis conjunto de 6 tratamientos 

```{r rinde_T6}
rinde_cura %>% 
  distinct(sitio, cultivo, prod) %>% 
  filter(sitio=="La Dulce") %>% 
  filter(cultivo=="trigo") %>%
  select(-sitio) %>% 
  left_join(rinde_cura) -> rinde_T6
ftable(xtabs(~ cultivo + prod + sitio, rinde_T6))
# rinde_T6 %>% filter(prod=="SISTIVA_PREMIS")
```

```{r}
# cebada_foliar %>% count(sitio, prod) %>% print(n=Inf)
# ftable(xtabs(~prod + sitio, cebada_foliar))
mod_rinde_T6 <- lmer(kg_ha ~ prod + (1|sitio/bq), data=rinde_T6)
# plot(mod_rinde_T6)
# check_heteroscedasticity(mod_rinde_T6) 
# check_normality(mod_rinde_T6)

mod_rinde_T6 %>% 
  emmeans(., ~ prod, type = "response") %>%  
  cld(., Letters = letters, alpha = .1,
      type = "response", reversed = T) %>%
  broom::tidy() %>% 
  rename(kg_ha = estimate, "tukey_10%"=.group) %>% select(-std.error, -df)
```

### Análisis conjunto de MDP + Tandil 

```{r}
rinde_cura %>% 
  filter(sitio!="La Dulce") %>% 
  filter(cultivo=="trigo") %>%
  filter(!prod=="SISTIVA_PREMIS_2X") -> rinde_T2 
ftable(xtabs(~ cultivo + prod + sitio, rinde_T2))
```

```{r}
mod_rinde_T2 <- lmer(kg_ha ~ prod + (1|sitio/bq),
                     data=rinde_T2)
# plot(mod_rinde_T2)
# check_heteroscedasticity(mod_rinde_T2)
# check_normality(mod_rinde_T2)

mod_rinde_T2 %>% 
  emmeans(., ~ prod, type = "response") %>%  
  cld(., Letters = letters, alpha = .1,
      type = "response", reversed = T) %>%
  broom::tidy() %>% 
  rename(kg_ha = estimate, "tukey_10%"=.group) %>% select(-std.error, -df)
```
