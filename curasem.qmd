---
title: "curasemillas"
format: html
---

```{r}
# https://github.com/juanchiem/apptest2/blob/master/app.R
library(tidyverse)
library(gsheet)
library(janitor)
library(patchwork)
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("select", "dplyr")
```
 # Cobertura

```{r}
"https://docs.google.com/spreadsheets/d/165Mu7j6k2QVZN4NPJvy42-WCj8WyH4C-flKlEF-NB4Y/edit#gid=1038456513" %>% 
      gsheet::gsheet2tbl() -> cober_raw
```

```{r}
cober_raw %>% str
```

```{r}
cober_dat <- cober_raw %>%
      filter(regional=="tandilia") %>%
      # filter(regional=="necochea") %>%
      pivot_longer(cols=contains("x"), names_to = "x", values_to = "val", 
                   names_prefix = "x") %>%   
      drop_na(val) %>% 
      left_join(plots_cura %>% 
                  pivot_longer(cols=contains("x"), 
                               names_to = "x", 
                               values_to = "crop_trat", 
                               names_prefix = "x")) %>% 
      separate(crop_trat, 
               into = c("crop", "trat"), 
               sep = "(?<=[A-Za-z])(?=[0-9])", 
               remove = F) %>% 
      mutate(crop = fct_rev(factor(crop)), 
             coords = paste(x, y, sep=","),
             x = as.numeric(x))  %>% 
      left_join(trat_cura %>% select(regional, crop_trat, trat_compact))
    
    # cober_dat 
    p1 <- cober_dat %>% #data.frame 
      # mydata$X <- factor(mydata$X, levels = unique(mydata$X))
      # mutate(x = as.numeric(x)) %>%
      ggplot()+
      cowplot::theme_minimal_grid()+
      viridis::scale_fill_viridis(discrete=FALSE, direction = -1)+
      labs(y="", x="", fill = "%", 
           title = "Cobertura canopeo", 
           subtitle= paste0("Estimado con app - ", 
                            unique(cober_dat$fecha)) )+
      geom_tile(aes(x, y, fill= val), alpha =0.9) +
      geom_text(aes(x = x, y=y,
                    label = paste0(crop, "\n", trat)), 
                col = "white", size = 3) +
      scale_x_continuous(breaks = seq(0, max(cober_dat$x), by = 1))+
      scale_y_continuous(breaks = seq(0, max(cober_dat$y), by = 1))
      # scale_x_continuous(breaks= scales::pretty_breaks(n = 20))
    # p1
    p2.stat <- cober_dat %>% #data.frame 
      ggplot()+
      aes(x=trat_compact, y= val, 
          # group=as.numeric(trat)
      )+
      # aes(x=trat, y= val, group=trat)+
      facet_wrap("crop", scales="free")+
      stat_summary(fun = "mean", geom = "crossbar", col="red")+
      geom_point(aes(text=sprintf("x: %s<br>y: %s", x, y)), alpha=.4)+
      labs(y="%", x="", col = "Tabl√≥n") + 
      theme_bw()+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

